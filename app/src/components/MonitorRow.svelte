<script lang="ts">
    import {
        TableBodyCell,
        TableBodyRow,
    } from "flowbite-svelte";
    import {
        BYPASS,
        ESTOP,
        GREEN_X,
        MOVE_STATION,
        WRONG_MATCH,
        type MonitorFrame,
        type TeamInfo,
        type Station,
        ASTOP,
        NO_CODE,
        RED,
        MATCH_OVER,
        MATCH_ABORTED,
        READY_FOR_POST_RESULT,
        READY_TO_PRESTART,
    } from "../../../shared/types";
    import { navigate } from "svelte-routing";
    import Graph from "./Graph.svelte";
    import type { MonitorFrameHandler } from "../util/monitorFrameHandler";
    import { processSignalStrengthForGraph } from "../util/signalStrengthProcessor";
    import { eventStore } from "../stores/event";

    export let station: Station;
    export let monitorFrame: MonitorFrame;
    export let fullscreen = false;
    export let statusChange: { lastChange: Date; improved: boolean };
    export let frameHandler: MonitorFrameHandler;
    let team: TeamInfo;
    $: {
        team = monitorFrame[station];
        parsedData = battery.map((d, i) => ({ time: i, data: d }));
        signalData = processSignalStrengthForGraph(frameHandler
        .getHistory(station, "signal", 20) as number[]);
    }

    export let detailView: (evt: Event) => void;

    function getKey(value: any) {
        return Object.keys(monitorFrame).find(
            (key) => (monitorFrame as any)[key] === value,
        );
    }

    const DS_Colors: { [key: number]: string } = {
        0: "bg-red-600",
        1: "bg-green-500",
        2: "bg-green-500",
        3: "bg-yellow-500",
        4: "bg-yellow-500",
        5: "bg-red-700",
        6: "bg-neutral-900",
        7: "bg-neutral-900",
    };

    const RIO_Colors: { [key: number]: string } = {
        0: "bg-red-600",
        1: "bg-yellow-500",
        2: "bg-green-500",
    };

    export let battery: number[];
    let parsedData = battery.map((d, i) => ({ time: i, data: d }));
    let signalData = processSignalStrengthForGraph(frameHandler
        .getHistory(station, "signal", 20) as number[]);
</script>

{#key team}
    <TableBodyRow
        class="{fullscreen
            ? 'h-16'
            : 'h-20 lg:h-24'} border-y border-gray-800 cursor-pointer"
        id="{station}-row"
    >
        <TableBodyCell
            class="text-center {getKey(team)?.startsWith('blue')
                ? 'bg-blue-600'
                : 'bg-red-600'} font-mono monitor-team {fullscreen
                ? 'monitor-fullscreen'
                : ''}"
            on:click={() => navigate("/notes/" + team.number)}
        >
            <p>{team.number}</p>
            <p style="letter-spacing: -8px;">
                {#if ![MATCH_OVER, MATCH_ABORTED, READY_FOR_POST_RESULT, READY_TO_PRESTART].includes(monitorFrame.field)}
                    {#if team.ds === RED && statusChange.lastChange.getTime() + 30e3 < Date.now()}
                        👀
                    {:else if team.ds === GREEN_X && statusChange.lastChange.getTime() + 30e3 < Date.now()}
                        👀
                    {:else if team.radio === RED && statusChange.lastChange.getTime() + 180e3 < Date.now()}
                        👀
                    {:else if team.rio === RED && statusChange.lastChange.getTime() + 45e3 < Date.now()}
                        👀
                    {:else if team.code === NO_CODE && statusChange.lastChange.getTime() + 30e3 < Date.now()}
                        👀
                    {/if}
                {/if}
                {#if !$eventStore.teams[team.number]?.inspected}
                    🔍
                {/if}
            </p>
        </TableBodyCell>
        <TableBodyCell
            class="{DS_Colors[
                team.ds
            ]} text-4xl text-black text-center {fullscreen
                ? 'ring-inset ring-4 ring-gray-800'
                : ''} border-x-2 border-gray-800 font-mono monitor-ds {fullscreen
                ? 'monitor-fullscreen'
                : ''}"
            on:click={detailView}
        >
            {#if team.ds === GREEN_X}
                X
            {:else if team.ds === MOVE_STATION}
                M
            {:else if team.ds === WRONG_MATCH}
                W
            {:else if team.ds === BYPASS}
                B
            {:else if team.ds === ESTOP}
                E
            {:else if team.ds === ASTOP}
                A
            {/if}
        </TableBodyCell>
        <TableBodyCell
            class="{DS_Colors[team.radio]} {fullscreen
                ? 'ring-inset ring-4 ring-gray-800'
                : 'border-x'} border-gray-800 "
            on:click={detailView}
        ></TableBodyCell>
        <TableBodyCell
            class="{RIO_Colors[(team.rio > 0 ? 1 : 0) + team.code]} {fullscreen
                ? 'ring-inset ring-4 ring-gray-800'
                : 'border-x'} border-gray-800"
            on:click={detailView}
        ></TableBodyCell>
        <TableBodyCell
            class="p-0 relative aspect-square"
            on:click={detailView}
            style="background-color: rgba(255,0,0,{team.battery < 11 &&
            team.battery > 0
                ? (-1.5 * team.battery ** 2 - 6.6 * team.battery + 255) / 255
                : 0})"
        >
            <div class="h-full text-center top-0 px-0.5 aspect-square">
                <Graph data={parsedData} min={6} max={14} time={20} />
            </div>
            <div
                class="absolute w-full bottom-0 p-2 monitor-battery {fullscreen
                    ? 'monitor-fullscreen'
                    : ''}"
            >
                {team.battery?.toFixed(1)}v
            </div>
        </TableBodyCell>
        {#if fullscreen}
            <TableBodyCell
                on:click={detailView}
                class="monitor-ping monitor-fullscreen"
                >{team.ping} ms</TableBodyCell
            >
            <TableBodyCell
                on:click={detailView}
                class="monitor-bwu monitor-fullscreen"
                >{team.bwu.toFixed(2)} mbps</TableBodyCell
            >
            <TableBodyCell
                class="p-0 relative aspect-square"
                on:click={detailView}
            >
                <div class="h-full text-center top-0 px-0.5 aspect-square">
                    <Graph data={signalData} min={-140} max={100} time={20} />
                </div>
                <div
                    class="absolute w-full bottom-0 p-2 monitor-signal monitor-fullscreen"
                >
                    {team.signal ? team.signal : 0} dBm
                </div>
            </TableBodyCell>
        {:else}
            <TableBodyCell on:click={detailView} class="monitor-net">
                {team.ping} ms<br />
                {team.bwu.toFixed(2)} mbps<br />
                {team.signal ? team.signal : 0} dBm
            </TableBodyCell>
        {/if}
    </TableBodyRow>
{/key}
